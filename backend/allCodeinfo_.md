# FIZZA Technical Backend Documentation (v3.3 - Code & Schemas)

**Status Date:** Dec 6, 2025
**Scope:** Full Monorepo Analysis (Apps, Packages, Functions)

This document provides a precise, code-based analysis of the FIZZA system's current capabilities. It focuses on the actual implemented logic in the backend (Domain, Data, Cloud Functions) and the state of the frontend applications.

---

## 1. High-Level Architecture

The system follows a **Clean Architecture** Monorepo structure, separating concerns into distinct packages shared across three applications.

*   **Apps Layer** (`apps/`): Contains the UI entry points.
    *   `user_app`: For parents/students.
    *   `driver_app`: For drivers.
    *   `admin_panel`: For system administrators.
    *   *Note: Currently, these apps are largely Flutter template shells (`main.dart` "Flutter Demo"). The core business logic resides in the packages.*
*   **Domain Layer** (`packages/fizza_domain`): **Pure Dart**. Defines Entities, Value Objects, Repository Interfaces, and Use Cases. It contains the "Source of Truth" for business rules (e.g., `SystemConfigEntity`).
*   **Data Layer** (`packages/fizza_data`): **Flutter + Firebase**. Implements Repository Interfaces. Handles direct Firestore interactions and calls to Cloud Functions.
*   **Core Layer** (`packages/fizza_core`): Shared utilities, failures, and base classes.
*   **Backend Layer** (`functions/`): **TypeScript**. Firebase Cloud Functions for complex server-side logic (Clustering, Financials, Analytics).

---

## 2. Capabilities by App (Backend Support)

*Since the UI applications are currently templates, the following capabilities are derived from the implemented Repositories and Use Cases available to each actor.*

### **User App (Parent/Student)**
*   **Authentication**: Login/Register via Firebase Auth (`AuthRepository`).
*   **Wallet**: View balance, top-up (mocked payment), view transaction history (`WalletRepository`).
*   **Subscriptions**:
    *   View available packages (Monthly, 3-Month, 6-Month, Family).
    *   Purchase subscription (creates `UserSubscriptionEntity`).
    *   Auto-renewal management.
*   **Rides**:
    *   View daily scheduled trips (Home â†” School).
    *   View assigned driver details.
    *   *Future*: Request on-demand ride (supported in backend but marked optional).
*   **Safety**: Submit safety reports (`SafetyRepository`).

### **Driver App**
*   **Status**: Toggle Online/Offline (`DriverRepository`).
*   **Trips**:
    *   View assigned daily trips.
    *   Start/Complete trips.
    *   Navigation (Maps integration is currently mocked).
*   **Earnings**: View daily/weekly earnings and ride counts (Real aggregation from `trips` collection).
*   **Profile**: View rating, tier (Standard/VIP/Female), and vehicle details.

### **Admin Panel**
*   **System Configuration**: Dynamically update global rules (`SystemConfig`):
    *   Pricing (Base fare, Commission %).
    *   Loyalty (Points per action, Level thresholds).
    *   Operational (Operating hours, Max distance).
*   **Driver Management**:
    *   View pending drivers.
    *   Approve/Reject driver applications.
    *   View driver stats.
*   **Complaints**: View and resolve pending safety reports.
*   **Analytics**: The dashboard uses stats_daily and stats_global/summary, including bestDriverId and worstDriverId generated by aggregateDailyStats.

---

## 3. Domain Layer (Entities & Rules)

The `fizza_domain` package encapsulates the Fixed Subscription business model.

### **System Configuration (`SystemConfigEntity`)**
*   **Pricing**: Defines `driverCommissionRate` (15%), `baseFare`, `pricePerKm`.
*   **Loyalty**: Defines points for:
    *   Ride (5), Monthly Sub (30), Long-term (100), Safety Report (40), Female Driver (10).
    *   Levels: Bronze, Silver, Gold.
*   **Operational**: Enforces `operatingStartHour` (6), `operatingEndHour` (23), `maxPickupDistanceKm` (10.0).

### **Driver (`DriverEntity`)**
*   **Tiers**: `standard`, `vip`, `female`.
*   **Commission**: Defaults to 0.15 (15%).
*   **Suspension**: Flags for `isSuspended` and `suspensionReason` (Auto-suspend on low rating or complaints).

### **Subscription (`UserSubscriptionEntity`)**
*   **Types**: Monthly, Family (`isFamily`, `parentUserId`), Female-Only (`isFemaleOnly`).
*   **Lifecycle**: `startDate`, `endDate`, `autoRenew`, `renewalStatus`.
*   **Usage**: Tracks `ridesRemaining`.

### **Add-Ons (`AddOnEntity`)**
*   Represents extras like "Night Ride", "Child Seat", "Extra Passenger".

---

## 4. Data Layer & Firebase Integration

The `packages/fizza_data` package implements the repository interfaces defined in the domain layer. It handles all direct interactions with Cloud Firestore and calls to Firebase Cloud Functions.

---

## 5. Firestore Collections & Schemas

### `beneficiaries/{beneficiaryId}`
*   `parent_user_id` (string)
*   `full_name` (string)
*   `relation` (string)
*   `school_name` (string, optional)
*   `grade` (string, optional)
*   `age` (number, optional)
*   `is_active` (bool)

### `stats_daily/{yyyy-mm-dd}`
*   `totalTrips` (number)
*   `totalRevenue` (number)
*   `totalDelay` (number, minutes)
*   `averageDelayMinutes` (number)
*   `complaintsCount` (number)
*   `activeSubscriptions` (number)
*   `bestDriverId` (string | null)
*   `worstDriverId` (string | null)
*   `generatedAt` (timestamp)

### `wallets/{uid}/transactions/{txId}`
*   `amount` (number, positive for credit, negative for debit)
*   `type` ('credit' | 'debit')
*   `description` (string)
*   `timestamp` (timestamp)
*   `paymentMethod` (string)
*   `referenceId` (string | null)

---

## 6. System Config (Technical)

Stored in `system_configs/default`. Keys are in `snake_case`:
*   **Pricing**: `base_fare`, `price_per_km`, `driver_commission_rate`, etc.
*   **Subscription**: `monthly_plan_price`, `monthly_ride_limit`.
*   **Loyalty**: `points_per_ride`, `points_female_driver`, `points_monthly_sub`, `points_long_term_sub`, `points_safety_report`, `level_thresholds`.
*   **Safety**: `max_rewarded_reports_per_month`.
*   **Operational**: `max_pickup_distance_km`.

---

## 7. Cloud Functions (`functions/src/index.ts`)

*   **`assignSubscriptionToDriver`**:
    *   **Trigger**: HTTPS Callable.
    *   **Logic**: Finds best driver within 10km, checks capacity (max 4), prioritizes family match.
    *   **Output**: Creates/Updates `user_subscriptions` doc.
*   **`completeDailyTrip`**:
    *   **Trigger**: HTTPS Callable.
    *   **Logic**: Calculates driver earnings (Commission model), updates `trips` and `drivers` stats, awards Loyalty Points via helper.
*   **`approveSafetyReport`**:
    *   **Trigger**: HTTPS Callable (Admin Only).
    *   **Logic**: Validates report, awards points (respecting monthly cap), updates status.
*   **`aggregateDailyStats`**:
    *   **Trigger**: Scheduled (Every 24h).
    *   **Logic**: Aggregates trips, revenue, complaints, active subs. Calculates `bestDriverId` and `worstDriverId`. Stores in `stats_daily/{date}`.
*   **`exportAnalytics`**:
    *   **Trigger**: HTTPS Callable (Admin Only).
    *   **Logic**: Exports CSV of daily stats (Financial, Operations, or Basic).

---

## 8. Loyalty Service

*   **Domain**: `ILoyaltyService`
*   **Data**: `LoyaltyServiceImpl`
*   **Cloud Helper**: `functions/src/loyalty.ts`
*   **Responsibilities**:
    *   Read loyalty configuration from `system_configs/default`.
    *   Update `users/{uid}.loyaltyPoints`.
    *   Methods: `awardPointsForRide`, `awardPointsForSubscription`, `awardPointsForSafetyReport`.
